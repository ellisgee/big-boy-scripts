#!/bin/bash -v

#Description:
#This converts Windows .RDG files into separate .rdp files so they can be easily imported into the MAC Remote Desktop client.

#Steps:
#1. Change the input variable in the script to point to your downloaded .rdg file
#2. Run the script (give the script perms 'chmod +x bashscript.sh')
#3. Open the Microsoft Remote desktop client
#4. Click the three dots and then 'Import from RDP File'
#5. Select the files that were generated by this script (it'll be in the output folder)

#Example RDG Record:
#<server>
#<name>WinServer01.company.local</name>
#<displayName>WinServer01.company.local Host</displayName>
#<comment />
#<comment>WinServer01.company.local</comment>
#<userName>Domain\User</userName>
#</server>

#Enter the full path to your downloaded RDG file.
input="#RDGFile"

echo $input

#Looks to see if the output folder exists in the current directory, if not then it creates the folder
if [[ ! -d ./output ]]; then
  mkdir ./output
fi
cd output

#Scans through the RDG file to find the start of each RDP file, creates a new record each time. Creates variables to be filled later.
while read -r line; do
    if [[ $line == *\<server\>* ]]; then
        echo "====NEW RECORD===="
        displayName=""
        name=""
        userName=""
    fi 

#Any line containing <displayName>, <name>, <userName> will be printed and filtered to delete the <displayName>, </displayName>,
#<name>, </name>, <userName>. </userName>

if [[ $line == *\<displayName\>* ]]; then
    displayName=$(echo "$line" | awk -F'<displayName>|</displayName>' '{print $2}')
    echo $displayName
fi

if [[ $line == *\<name\>* ]]; then
    name=$(echo "$line" | awk -F '<name>|</name>' '{print $2}')
    echo $name
fi

if [[ $line == *\<userName\>* ]]; then
    userName=$(echo "$line" | awk -F'<userName>|</userName>' '{print $2}')
    echo $userName
fi

#Once we reach </server> it's the end of an individual RDP file in the RDG file. Names the files,
#adds the details from above and some extra settings for RDP (which aren't necessary)

if [[ $line == *\</server\>* ]]; then
    echo "Creating .rdp file..."
    cat << EOF > "$displayName.rdp"
full address:s:$name
username:s:$userName
smart sizing:i:1
armpath:s:
targetisaadjoined:i:0
hubdiscoverygeourl:s:
redirected video capture encoding quality:i:0
camerastoredirect:s:*
gatewaybrokeringtype:i:0
use redirection server name:i:0
alternate shell:s:
disable themes:i:0
geo:s:
disable cursor setting:i:1
remoteapplicationname:s:
resourceprovider:s:
disable menu anims:i:1
remoteapplicationcmdline:s:
promptcredentialonce:i:0
gatewaycertificatelogonauthority:s:
audiocapturemode:i:1
prompt for credentials on client:i:0
gatewayhostname:s:
remoteapplicationprogram:s:
gatewayusagemethod:i:2
screen mode id:i:2
use multimon:i:0
authentication level:i:2
desktopwidth:i:0
desktopheight:i:0
redirectsmartcards:i:1
redirectclipboard:i:1
forcehidpioptimizations:i:0
drivestoredirect:s:
loadbalanceinfo:s:
networkautodetect:i:1
enablecredsspsupport:i:1
redirectprinters:i:1
autoreconnection enabled:i:1
session bpp:i:32
administrative session:i:0
audiomode:i:0
bandwidthautodetect:i:1
authoring tool:s:
connection type:i:7
remoteapplicationmode:i:0
disable full window drag:i:0
gatewayusername:s:
dynamic resolution:i:1
shell working directory:s:
wvd endpoint pool:s:
remoteapplicationappid:s:
allow font smoothing:i:1
connect to console:i:0
disable wallpaper:i:0
gatewayaccesstoken:s:
EOF
fi
done < "$input"
